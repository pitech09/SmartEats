{% extends "layout.html" %}
{% block title %}Cart - SmartEats{% endblock %}

{% block content %}
<div class="container my-5">
  <h2 class="text-center text-success mb-4">Your Cart</h2>

  <div class="row g-4">
    <!-- Payment Codes -->
    <div class="col-md-4">
      <div class="card shadow-sm border-success h-100">
        <div class="card-header bg-success text-white">
          <h5>Payment Codes</h5>
        </div>
        <div class="card-body">
          <p><strong>Mpesa:</strong> {{ store.mpesa_shortcode }}</p>
          <p><strong>Ecocash:</strong> {{ store.ecocash_short_code }}</p>
          <p class="text-muted small">Use these codes for secure payment. Enter your number correctly during checkout.</p>
        </div>
      </div>
    </div>

    <!-- Cart Items -->
    <div class="col-md-8">
      <div class="card shadow-sm border-primary">
        <div class="card-header bg-primary text-white">
          <h5>Cart Items</h5>
        </div>
        <div class="card-body">
          {% if not cart or cart.cart_items|length == 0 %}
            <p class="text-center text-muted">Your cart is empty!</p>
          {% else %}
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Item</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Remove</th>
              </tr>
            </thead>
            <tbody id="cart-items">
              {% for item in cart.cart_items %}
              <tr data-item-id="{{ item.id }}">
                <td>{{ item.get_name() }}</td>
                <td>M{{ '%.2f'|format(item.get_price()) }}</td>
                <td class="item-qty">{{ item.quantity }}</td>
                <td>M{{ '%.2f'|format(item.get_total()) }}</td>
                <td>
                  <button class="btn btn-outline-danger btn-sm remove-item" data-id="{{ item.id }}">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}

          <!-- Total & Checkout -->
          <div class="d-flex justify-content-between align-items-center mt-3">
            <h5>Total: <span id="total-price" data-base="{{ '%.2f'|format(total_amount) }}">M{{ '%.2f'|format(total_amount) }}</span></h5>
            <p class="text-muted mb-0 small">M6.00 will be added if delivery agent is selected.</p>
          </div>

          <hr>

          <!-- Order Form -->
          <form id="order-form" action="{{ url_for('main.addorder', total_amount=total_amount) }}" method="POST" enctype="multipart/form-data">
            {{ form3.hidden_tag() }}

            <div class="mb-3">
              {{ form3.payment.label }} {{ form3.payment(class='form-control') }}
            </div>
            <div class="mb-3">
              {{ form3.payment_number.label }} {{ form3.payment_number(class='form-control') }}
            </div>

            <div class="mb-3">
              {{ form3.deliverymethod.label }}
              {% for subfield in form3.deliverymethod %}
              <div class="form-check">
                {{ subfield(class="form-check-input delivery-option") }}
                {{ subfield.label(class="form-check-label") }}
              </div>
              {% endfor %}
            </div>

            <div class="mb-3">
              {{ form3.drop_address.label }} {{ form3.drop_address(class='form-control') }}
            </div>

            <div class="mb-3">
              {{ form3.payment_screenshot.label }} {{ form3.payment_screenshot(class='form-control') }}
            </div>

            <button type="submit" class="btn btn-success btn-lg w-100 rounded-pill">Place Order</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const totalPriceEl = document.getElementById('total-price');
    let baseTotal = parseFloat(totalPriceEl.dataset.base);

    function updateTotal() {
        const selectedOption = document.querySelector('.delivery-option:checked');
        let newTotal = baseTotal;
        if (selectedOption && selectedOption.value === 'agent') {
            newTotal += 6;
        }
        totalPriceEl.textContent = `M${newTotal.toFixed(2)}`;
    }

    document.querySelectorAll('.delivery-option').forEach(opt => opt.addEventListener('change', updateTotal));

    document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', async () => {
            const itemId = btn.dataset.id;
            try {
                const res = await fetch(`/remove_from_cart_ajax/${itemId}`, { method: 'POST' });
                const result = await res.json();
                if (result.success) {
                    document.querySelector(`tr[data-item-id="${itemId}"]`).remove();
                    baseTotal = parseFloat(result.cart_total);
                    totalPriceEl.dataset.base = baseTotal;
                    updateTotal();
                }
            } catch (err) {
                console.error('Error removing item:', err);
            }
        });
    });

    updateTotal();
});
</script>

<style>
.table-hover tbody tr:hover { background-color: #e6f7f1; }
.remove-item:hover { transform: scale(1.1); transition: 0.2s; }
.card { border-radius: 15px; }
.card-header { font-weight: bold; font-size: 1.1rem; }
#total-price { font-weight: bold; color: #00b37e; }
</style>
{% endblock %}
