{% extends "layout.html" %}
{% block title %}Cart - SmartEats{% endblock %}

{% block content %}
<div class="container my-5">
  <h2 class="text-center text-success mb-4">Checking out from {{store.name}}</h2>

  <div class="row g-4">
            <h3 class="card-title text-success fw-semibold">
                {% if is_store_open(store.openinghours) %}
                    <span class="badge bg-success ms-2">Store is Open. Enjoy your meal!</span>
                    {% else %}
                    <span class="badge bg-danger ms-2">Store is Closed, Please Come Back During its Operating Hours</span>
                {% endif %}
            </h3>
    <!-- Payment Codes -->
    <div class="col-md-4">
      <div class="card shadow-sm border-success h-100">
        <div class="card-header bg-success text-white">
          <h5>Payment Codes</h5>

        </div>
        <div class="card-body">
          <p><strong>Mpesa:</strong> {{ store.mpesa_shortcode }}</p>
          <p><strong>Mpesa Name:</strong> {{ store.mpesaname }}</p>
          
          <p><strong>Ecocash:</strong> {{ store.ecocash_short_code }}</p>
          <p><strong>Ecocash Name:</strong> {{ store.ecocash_name }}</p>
          <p class="text-muted small">
            Use these codes for secure payment. Location will be used to calculate delivery fee.
          </p>
        </div>
      </div>
    </div>

    <!-- Cart Items -->
    <div class="col-md-8">
      <div class="card shadow-sm border-primary">
        <div class="card-header bg-primary text-white">
          <h5>Cart Items</h5>
        </div>
        <div class="card-body">

          {% if not cart or cart.cart_items|length == 0 %}
            <p class="text-center text-muted">Your cart is empty!</p>
          {% else %}
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Item</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="cart-items">
              {% for item in cart.cart_items %}
              <tr data-item-id="{{ item.id }}">
                <td>{{ item.get_name() }}</td>
                <td>M{{ '%.2f'|format(item.get_price()) }}</td>
                <td>{{ item.quantity }}</td>
                <td>M{{ '%.2f'|format(item.get_total()) }}</td>
                <td>
                  <button class="btn btn-outline-danger btn-sm remove-item" data-id="{{ item.id }}">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}

          <!-- Totals -->
          <div class="d-flex justify-content-between mt-3">
            <h5>
              Subtotal:
              <span id="subtotal" data-base="{{ '%.2f'|format(total_amount) }}">
                M{{ '%.2f'|format(total_amount) }}
              </span>
            </h5>
          </div>

          <div class="d-flex justify-content-between mt-2">
            <h5>
              Delivery Fee:
              <span id="delivery-fee">M0.00</span>
            </h5>
          </div>

          <div class="d-flex justify-content-between mt-2">
            <h5>
              Total:
              <span id="grand-total">{{ '%.2f'|format(total_amount) }}</span>
            </h5>
          </div>

          <hr>

          <!-- Map for accurate location -->
          <div class="mb-3">
            <label class="form-label">Drag the marker to your location:</label>
            <div id="cart-map" style="height:300px; border:1px solid #ccc; border-radius:8px;"></div>
          </div>

          <!-- Checkout Form -->
          <form id="order-form"
                action="{{ url_for('main.addorder', total_amount=total_amount) }}"
                method="POST"
                enctype="multipart/form-data">

            {{ form3.hidden_tag() }}

            <!-- GPS hidden fields -->
            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">

            <div class="mb-3">
              {{ form3.payment.label }}
              {{ form3.payment(class="form-control") }}
            </div>

            <div class="mb-3">
              {{ form3.payment_number.label }}
              {{ form3.payment_number(class="form-control") }}
            </div>

            <div class="mb-3">
              {{ form3.deliverymethod.label }}
              {% for subfield in form3.deliverymethod %}
              <div class="form-check">
                {{ subfield(class="form-check-input delivery-option") }}
                {{ subfield.label(class="form-check-label") }}
              </div>
              {% endfor %}
            </div>

            <div class="mb-3">
              {{ form3.drop_address.label }}
              {{ form3.drop_address(class="form-control") }}
            </div>

            <div class="mb-3">
              <p>Screenshot or photo of your payment.</p>
              {{ form3.payment_screenshot.label }}
              {{ form3.payment_screenshot(class="form-control") }}
            </div>

            <button type="submit"
                    class="btn btn-success btn-lg w-100 rounded-pill">
              Place Order
            </button>

          </form>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const subtotalEl = document.getElementById('subtotal');
    const deliveryEl = document.getElementById('delivery-fee');
    const grandEl = document.getElementById('grand-total');
    let baseTotal = parseFloat(subtotalEl.dataset.base);

    const latInput = document.getElementById('latitude');
    const lngInput = document.getElementById('longitude');

    const storeLat = {{ store.latitude }};
    const storeLng = {{ store.longitude }};
    const storeRadius = 500;

    // Haversine distance in meters
    function distanceMeters(lat1, lon1, lat2, lon2){
        const R = 6371000;
        const toRad = x => x * Math.PI/180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function calculateDeliveryFee(meters){
        const insideMinFee = 8;
        const normalMinFee = 13;
        const maxFee = 10000;
        const ratePerMeter = 0.007;
        
        let fee = meters <= storeRadius ? insideMinFee : Math.max(meters * ratePerMeter, normalMinFee);
        console.log(`Distance: ${meters.toFixed(2)} m, Calculated Fee: M${fee.toFixed(2)}`);
        return Math.min(fee, maxFee);
    }

    // Map initialization (same as before)
    const map = L.map('cart-map').setView([storeLat, storeLng], 12);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const storeMarker = L.marker([storeLat, storeLng]).addTo(map).bindPopup('Store Location').openPopup();
    const storeCircle = L.circle([storeLat, storeLng], {
        radius: storeRadius,
        color: 'blue',
        fillColor: '#add8e6',
        fillOpacity: 0.3
    }).addTo(map);

    let line, labelMarker;
    function updateLineAndTotals(customerLat, customerLng){
        const meters = distanceMeters(storeLat, storeLng, customerLat, customerLng);
        const fee = calculateDeliveryFee(meters);
        const distanceLabel = meters > 1000 ? (meters/1000).toFixed(2) + ' km' : meters.toFixed(0) + ' m';

        if(line) map.removeLayer(line);
        if(labelMarker) map.removeLayer(labelMarker);

        line = L.polyline([[storeLat, storeLng], [customerLat, customerLng]], {color:'red'}).addTo(map);
        const midpointLat = (storeLat + customerLat)/2;
        const midpointLng = (storeLng + customerLng)/2;
        labelMarker = L.marker([midpointLat, midpointLng], {
            icon: L.divIcon({
                className: 'distance-label',
                html: `<div style="background:white;padding:2px 4px;border:1px solid red;border-radius:4px;font-size:12px;">
                        ${distanceLabel} | M${fee.toFixed(2)}
                       </div>`,
                iconSize: [100,20]
            })
        }).addTo(map);

        deliveryEl.textContent = `M${fee.toFixed(2)}`;
        grandEl.textContent = (baseTotal + fee).toFixed(2);

        latInput.value = customerLat;
        lngInput.value = customerLng;

        storeCircle.setStyle({fillColor: meters <= storeRadius ? '#90ee90' : '#add8e6', color: meters <= storeRadius ? '#008000' : 'blue'});
    }

    const customerMarker = L.marker([storeLat, storeLng + 0.01], {draggable:true}).addTo(map).bindPopup('Customer Location').openPopup();
    updateLineAndTotals(customerMarker.getLatLng().lat, customerMarker.getLatLng().lng);
    customerMarker.on('drag', e => {
        const pos = e.target.getLatLng();
        updateLineAndTotals(pos.lat, pos.lng);
    });
    map.fitBounds([[storeLat, storeLng],[customerMarker.getLatLng().lat, customerMarker.getLatLng().lng]]);

    // Delivery option selection
    document.querySelectorAll('.delivery-option').forEach(opt => {
        opt.addEventListener('change', () => {
            if(opt.value !== 'agent' || !opt.checked){
                deliveryEl.textContent = "M0.00";
                grandEl.textContent = baseTotal.toFixed(2);
            } else {
                updateLineAndTotals(customerMarker.getLatLng().lat, customerMarker.getLatLng().lng);
            }
        });
    });

    // **Decrement item quantity instead of removing whole row**
    document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', async () => {
            const itemId = btn.dataset.id;
            const res = await fetch(`/decrement_cart_item/${itemId}`, {method:'POST'}); // endpoint decrements quantity
            const result = await res.json();
            if(result.success){
                const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
                const qtyEl = row.querySelector('.item-qty');
                if(result.new_quantity > 0){
                    qtyEl.textContent = result.new_quantity;
                } else {
                    row.remove(); // remove if quantity reaches 0
                }
                baseTotal = parseFloat(result.cart_total);
                subtotalEl.dataset.base = baseTotal;
                subtotalEl.textContent = `M${baseTotal.toFixed(2)}`;
                updateLineAndTotals(customerMarker.getLatLng().lat, customerMarker.getLatLng().lng);
            }
        });
    });

});
</script>

<style>
.card { border-radius: 15px; }
.card-header { font-weight: bold; }
.table-hover tbody tr:hover { background-color: #e6f7f1; }
.remove-item:hover { transform: scale(1.1); transition: 0.2s; }
#subtotal, #grand-total { font-weight: bold; color: #00b37e; }
#delivery-fee { font-weight: bold; color: #ff7f50; }
</style>
{% endblock %}
