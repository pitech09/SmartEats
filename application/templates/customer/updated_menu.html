{% extends "layout.html" %}
{% block title %}{{ store.name }} Menu - SmartEats{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- Header -->
  <div class="text-center mb-4">
    <h2 class="text-success">{{ store.name }} Menu</h2>
    <p class="text-muted">Browse and add your favorite meals to the cart!</p>
  </div>
    {% if missing_location %}
  <div class="alert alert-warning text-center rounded-pill">
      <i class="fas fa-exclamation-triangle me-2"></i>
      Please update your <strong>district</strong> and <strong>town</strong> to get personalized store listings.
  </div>
  {% endif %}


  <!-- Search Bar -->
  <div class="mb-4">
    <form id="searchForm" action="{{ url_for('main.search', page_num=1) }}" method="post" class="d-flex justify-content-center">
      {{ form2.hidden_tag() }}
      <div class="input-group w-75">
        {{ form2.keyword(class='form-control border-0 shadow-sm', placeholder='Search for meals...') }}
        <button class="btn btn-success" type="submit">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </form>
  </div>

  <!-- Category Filters -->
  <div class="mb-4 d-flex flex-wrap justify-content-center gap-2">
    <a href="{{ url_for('main.menu', page_num=page_num) }}"
       class="btn {% if not selected_category_id %}btn-success{% else %}btn-outline-success{% endif %} rounded-pill">
        All
    </a>
    {% for cat in categories %}
    <a href="{{ url_for('main.menu', page_num=page_num, category=cat.id) }}"
       class="btn {% if selected_category_id == cat.id %}btn-success{% else %}btn-outline-success{% endif %} rounded-pill">
        {{ cat.name }}
    </a>
    {% endfor %}
  </div>

  <!-- Product Grid -->
  <div class="row row-cols-1 row-cols-md-3 g-4">
    {% for product in products %}
    <div class="col">
      <div class="card h-100 shadow-sm border-0 product-card">
        <img src="{{ product.pictures }}" class="card-img-top" alt="{{ product.productname }}" loading="lazy">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title text-success">{{ product.productname }}</h5>
          <p class="card-text text-muted mb-2">{{ product.description|truncate(80) }}</p>
          <p class="fw-bold mb-3">M{{ '%.2f'|format(product.price) }}</p>
          <div class="mt-auto d-flex justify-content-between align-items-center">
            <a href="{{ url_for('main.viewproduct', product_id=product.id) }}" class="btn btn-outline-info btn-sm">More...</a>
            <button 
              class="btn btn-success btn-sm rounded-pill add-to-cart-btn"
              data-id="{{ product.id }}"
            >
              <i class="fas fa-cart-plus me-1"></i> Add
            </button>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-center align-items-center mt-4">
    {% if page_num > 1 %}
      <a href="{{ url_for('main.menu', page_num=page_num - 1, category=selected_category_id) }}" class="btn btn-outline-secondary me-2">Previous</a>
    {% endif %}
    <span class="mx-2">Page {{ page_num }} of {{ total_pages }}</span>
    {% if page_num < total_pages %}
      <a href="{{ url_for('main.menu', page_num=page_num + 1, category=selected_category_id) }}" class="btn btn-outline-secondary ms-2">Next</a>
    {% endif %}
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const cartIcon = document.getElementById("cartIcon");
    const cartCountEl = document.getElementById("cartCount");

    // Add Product to Cart
    document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
            const productId = btn.dataset.id;

            try {
                const response = await fetch("/add_to_cart_ajax", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ product_id: productId, store_id: {{ store.id }} })
                });

                const data = await response.json();
                if (data.success) {
                    // Update cart count
                    if (cartCountEl) cartCountEl.textContent = data.cart_count;
                    if (cartIcon && cartIcon.classList.contains("d-none")) {
                        cartIcon.classList.remove("d-none");
                    }

                    // Animate cart icon
                    if (cartIcon) {
                        cartIcon.classList.add("scale-up");
                        setTimeout(() => cartIcon.classList.remove("scale-up"), 300);
                    }

                    // Button feedback
                    btn.classList.add('btn-success');
                    btn.innerHTML = 'Added <i class="fas fa-check-circle ms-1"></i>';
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-cart-plus me-1"></i> Add';
                    }, 800);
                }
            } catch (err) {
                console.error("Error adding to cart:", err);
            }
        });
    });

    // SocketIO: update cart from other tabs
    const socket = io();
    socket.on("cart_updated", data => {
        if (cartCountEl) cartCountEl.textContent = data.cart_count;
        if (cartIcon && parseInt(data.cart_count) > 0) cartIcon.classList.remove("d-none");
    });
});
</script>

<style>
/* Card hover effects */
.product-card:hover {
  transform: translateY(-3px);
  transition: 0.3s;
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}

/* Product image */
.card-img-top {
  width: 60%;
  height: auto;
  margin: 0 auto;
  object-fit: contain;
  border-radius: 12px 12px 0 0;
}

/* Search bar style */
input.form-control {
  border-radius: 50px !important;
  padding-left: 1.5rem;
}

/* Add button hover effect */
.add-to-cart-btn:hover {
  background-color: #28a745;
  color: white;
  transform: scale(1.05);
  transition: 0.2s;
}

/* Cart animation */
#cartIcon.scale-up {
  transform: scale(1.2);
  transition: transform 0.3s ease;
}
</style>
{% endblock %}
