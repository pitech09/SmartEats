{% extends "layout.html" %}
{% block title %}{{ product.productname }} - SmartEats{% endblock %}

{% block content %}

<style>
    .product-container {
        max-width: 950px;
        margin: auto;
        padding-top: 30px;
    }

    .product-card {
        background: #fff;
        border-radius: 18px;
        padding: 25px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    }

    .product-image {
        border-radius: 16px;
        width: 100%;
        height: 280px;
        object-fit: cover;
    }

    .related-img {
        height: 120px;
        object-fit: cover;
    }
</style>

<div class="product-container">

    <!-- Title -->
    <h1 class="mb-4 text-success">{{ product.productname }}</h1>

    <!-- Product Card -->
    <div class="product-card row g-4">
        <div class="col-md-5">
            <img 
                class="product-image"
                src="{{ product.pictures }}"
                alt="{{ product.productname }}"
                loading="lazy"
            >
        </div>

        <div class="col-md-7 d-flex flex-column">
            <h4>Description</h4>
            <p class="text-muted">{{ product.description }}</p>

            <h4 class="mt-3">Price</h4>
            <p class="fs-3 fw-bold text-success">M {{ product.price }}</p>

            <!-- ADD TO CART (SAME AS MENU) -->
            <button
                class="btn btn-success btn-lg rounded-pill mt-auto add-to-cart-btn"
                data-id="{{ product.id }}"
            >
                <i class="fas fa-cart-plus me-2"></i> Add to Cart
            </button>
        </div>
    </div>

    <!-- Related Products -->
    {% if related_products %}
    <div class="mt-5">
        <h3>Other items from {{ store.name }}</h3>
        <div class="row mt-3">

            {% for item in related_products %}
            <div class="col-6 col-md-3 mb-4 text-center">
                <a 
                    href="{{ url_for('main.viewproduct', product_id=item.id) }}"
                    class="text-decoration-none text-dark"
                >
                    <img 
                        src="{{ item.pictures }}"
                        class="img-fluid rounded mb-2 related-img"
                        loading="lazy"
                    >
                    <p class="mb-1 fw-bold">{{ item.productname }}</p>
                    <p class="text-success">M {{ item.price }}</p>
                </a>
            </div>
            {% endfor %}

        </div>
    </div>
    {% endif %}

</div>

<!-- SAME JS AS MENU PAGE -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const cartIcon = document.getElementById("cartIcon");
    const cartCountEl = document.getElementById("cartCount");

    document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
            const productId = btn.dataset.id;

            try {
                const response = await fetch("/add_to_cart_ajax", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        product_id: productId,
                        store_id: {{ store.id }}
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Update cart count
                    if (cartCountEl) {
                        cartCountEl.textContent = data.cart_count;
                    }

                    // Show cart icon if hidden
                    if (cartIcon && cartIcon.classList.contains("d-none")) {
                        cartIcon.classList.remove("d-none");
                    }

                    // Animate cart icon
                    if (cartIcon) {
                        cartIcon.classList.add("scale-up");
                        setTimeout(() => {
                            cartIcon.classList.remove("scale-up");
                        }, 300);
                    }

                    // Button feedback
                    btn.innerHTML = "Added âœ“";
                    btn.disabled = true;

                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-cart-plus me-2"></i> Add to Cart';
                        btn.disabled = false;
                    }, 1200);
                }
            } catch (err) {
                console.error("Add to cart failed:", err);
            }
        });
    });

    // SocketIO sync (same as menu)
    const socket = io();
    socket.on("cart_updated", data => {
        if (cartCountEl) cartCountEl.textContent = data.cart_count;
        if (cartIcon && parseInt(data.cart_count) > 0) {
            cartIcon.classList.remove("d-none");
        }
    });
});
</script>

{% endblock %}
