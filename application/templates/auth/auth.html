{% extends "layout.html" %}
{% block title %}SmartEats Auth{% endblock %}

{% block content %}
<div class="container-xxl py-5">
  <div class="authentication-wrapper authentication-basic container-p-y">
    <div class="authentication-inner">

      <!-- Card -->
      <div class="card shadow-sm" id="auth-card">
        <div class="card-body">

          <!-- Dynamic Header -->
          <h4 class="mb-2" id="auth-header">Welcome to SmartEats!</h4>
          <p class="mb-4" id="auth-subheader">Please select an action below.</p>

          <!-- Message -->
          <div id="auth-message" class="mb-3"></div>

          <!-- Forms -->
          <div id="auth-forms">

            <!-- Login Form -->
            <form id="login-form" class="auth-form d-none">
              {{ login_form.hidden_tag() }}
              <div class="mb-3">
                {{ login_form.email.label(class="form-label") }}
                {{ login_form.email(class="form-control", placeholder="example@email.com") }}
              </div>
              <div class="mb-3 form-password-toggle">
                {{ login_form.password.label(class="form-label") }}
                <div class="input-group input-group-merge">
                  {{ login_form.password(class="form-control", placeholder="••••••••") }}
                  <span class="input-group-text cursor-pointer"><i class="fas fa-eye-slash"></i></span>
                </div>
              </div>
              <button type="submit" class="btn btn-success d-grid w-100 mb-2">Login</button>
              <small><a href="#" data-target="register">Create Account</a> | <a href="#" data-target="reset">Forgot Password?</a></small>
            </form>

            <!-- Register Form -->
            <form id="register-form" class="auth-form d-none">
              {{ register_form.hidden_tag() }}
              <div class="mb-3">
                {{ register_form.username.label(class="form-label") }}
                {{ register_form.username(class="form-control", placeholder="First Name") }}
              </div>
              <div class="mb-3">
                {{ register_form.lastName.label(class="form-label") }}
                {{ register_form.lastName(class="form-control", placeholder="Last Name") }}
              </div>
              <div class="mb-3">
                {{ register_form.Email.label(class="form-label") }}
                {{ register_form.Email(class="form-control", placeholder="Email") }}
              </div>
              <div class="mb-3 form-password-toggle">
                {{ register_form.Password.label(class="form-label") }}
                <div class="input-group input-group-merge">
                  {{ register_form.Password(class="form-control", placeholder="••••••••") }}
                  <span class="input-group-text cursor-pointer"><i class="fas fa-eye-slash"></i></span>
                </div>
              </div>
              <button type="submit" class="btn btn-success d-grid w-100 mb-2">Register</button>
              <small><a href="#" data-target="login">Already have an account? Login</a></small>
            </form>

            <!-- Register Store Form -->
            <form id="registerstore-form" class="auth-form d-none">
              {{ store_form.hidden_tag() }}
              <div class="mb-3">
                {{ store_form.pharmacy_name.label(class="form-label") }}
                {{ store_form.pharmacy_name(class="form-control") }}
              </div>
              <div class="mb-3">
                {{ store_form.email.label(class="form-label") }}
                {{ store_form.email(class="form-control") }}
              </div>
              <div class="mb-3">
                {{ store_form.phone.label(class="form-label") }}
                {{ store_form.phone(class="form-control") }}
              </div>
              <div class="mb-3">
                {{ store_form.address.label(class="form-label") }}
                {{ store_form.address(class="form-control") }}
              </div>
              <div class="mb-3">
                {{ store_form.opening_hours_and_days.label(class="form-label") }}
                {{ store_form.opening_hours_and_days(class="form-control") }}
              </div>
              <div class="mb-3 form-password-toggle">
                {{ store_form.password.label(class="form-label") }}
                <div class="input-group input-group-merge">
                  {{ store_form.password(class="form-control") }}
                  <span class="input-group-text cursor-pointer"><i class="fas fa-eye-slash"></i></span>
                </div>
              </div>
              <button type="submit" class="btn btn-success d-grid w-100 mb-2">Register Store</button>
              <small><a href="#" data-target="login">Back to login</a></small>
            </form>

            <!-- Resend Email Form -->
            <form id="resend-form" class="auth-form d-none">
              {{ resend_form.hidden_tag() }}
              <div class="mb-3">
                {{ resend_form.email.label(class="form-label") }}
                {{ resend_form.email(class="form-control") }}
              </div>
              <button type="submit" class="btn btn-primary d-grid w-100 mb-2">Resend Email</button>
              <small><a href="#" data-target="login">Back to login</a></small>
            </form>

            <!-- Reset Password Form -->
            <form id="reset-form" class="auth-form d-none">
              {{ reset_form.hidden_tag() }}
              <div class="mb-3">
                {{ reset_form.password.label(class="form-label") }}
                {{ reset_form.password(class="form-control") }}
              </div>
              <button type="submit" class="btn btn-primary d-grid w-100 mb-2">Reset Password</button>
              <small><a href="#" data-target="login">Back to login</a></small>
            </form>

          </div>
        </div>
      </div>
      <!-- /Card -->

    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const forms = document.querySelectorAll('.auth-form');
  const messageBox = document.getElementById('auth-message');

  function showForm(target) {
    forms.forEach(f => f.classList.add('d-none'));
    const form = document.getElementById(`${target}-form`);
    if (form) form.classList.remove('d-none');
    messageBox.innerHTML = '';
  }

  // Initial load: show login form
  showForm('login');

  // Toggle links
  document.querySelectorAll('a[data-target]').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const target = e.currentTarget.dataset.target;
      showForm(target);
    });
  });

  // Password toggle
  document.querySelectorAll('.form-password-toggle .input-group-text').forEach(icon => {
    icon.addEventListener('click', () => {
      const input = icon.previousElementSibling;
      if (input.type === 'password') {
        input.type = 'text';
        icon.querySelector('i').classList.replace('fa-eye-slash','fa-eye');
      } else {
        input.type = 'password';
        icon.querySelector('i').classList.replace('fa-eye','fa-eye-slash');
      }
    });
  });

  // AJAX submit
  forms.forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const action = form.id.replace('-form','');
      const url = `/auth/${action}`;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      messageBox.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          body: new URLSearchParams(data)
        });

        const result = await response.json();
        if(result.status === 'success'){
          messageBox.innerHTML = `<div class="alert alert-success">${result.message || 'Success!'}</div>`;
          if(result.redirect) setTimeout(()=> window.location.href=result.redirect, 1000);
        } else {
          if(result.errors){
            const errs = Object.values(result.errors).flat().join('<br>');
            messageBox.innerHTML = `<div class="alert alert-danger">${errs}</div>`;
          } else {
            messageBox.innerHTML = `<div class="alert alert-danger">${result.message || 'Error occurred'}</div>`;
          }
        }
      } catch(err){
        console.error(err);
        messageBox.innerHTML = `<div class="alert alert-danger">Server error</div>`;
      }
    });
  });

});
</script>
{% endblock %}
