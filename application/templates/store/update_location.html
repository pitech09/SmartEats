{% extends "adminlayout.html" %}
{% block title %}Update Store Location{% endblock %}

{% block content %}
<div class="container my-5">
  <h2 class="text-center mb-4">Update Store Location</h2>

  <form method="POST" action="{{ url_for('store.update_store_location') }}">
    {{ form.hidden_tag() }}

    <div class="mb-3">
      {{ form.latitude.label }}
      {{ form.latitude(class='form-control', id='latitude') }}
    </div>

    <div class="mb-3">
      {{ form.longitude.label }}
      {{ form.longitude(class='form-control', id='longitude') }}
    </div>

    <div class="mb-3">
      <button type="button" class="btn btn-primary" id="use-location">
        Use My Current Location
      </button>
    </div>

    <!-- Small map below the form -->
    <div id="map" style="height:300px; border:1px solid #ccc; border-radius:8px;"></div>

    <button type="submit" class="btn btn-success mt-3">Save Location</button>
  </form>
</div>

<!-- Local Leaflet files -->
<link rel="stylesheet" href="{{ url_for('static', filename='lib/leaflet.css') }}">
<script src="{{ url_for('static', filename='lib/leaflet.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const latInput = document.getElementById('latitude');
  const lngInput = document.getElementById('longitude');
  const useBtn = document.getElementById('use-location');

  // Default coordinates (fallback)
  let lat = latInput.value ? parseFloat(latInput.value) : -28.895383;
  let lng = lngInput.value ? parseFloat(lngInput.value) : 24.767190;
  let zoom = latInput.value && lngInput.value ? 16 : 5;

  // Initialize map
  const map = L.map('map').setView([lat, lng], zoom);

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Marker
  let marker = L.marker([lat, lng], { draggable: true }).addTo(map);

  // Sync marker → inputs
  marker.on('dragend', e => {
    const pos = e.target.getLatLng();
    latInput.value = pos.lat.toFixed(6);
    lngInput.value = pos.lng.toFixed(6);
  });

  // Sync inputs → marker
  function updateMarker(latitude, longitude) {
    latInput.value = latitude.toFixed(6);
    lngInput.value = longitude.toFixed(6);
    marker.setLatLng([latitude, longitude]);
    map.setView([latitude, longitude], 16);
  }

  // Fetch user location (auto)
  function fetchCurrentLocation() {
    if (!navigator.geolocation) return;

    navigator.geolocation.getCurrentPosition(
      position => {
        updateMarker(
          position.coords.latitude,
          position.coords.longitude
        );
      },
      () => console.warn('Geolocation permission denied')
    );
  }

  // Button click
  useBtn.addEventListener('click', fetchCurrentLocation);

  // Auto-fetch on load if inputs empty
  if (!latInput.value || !lngInput.value) {
    fetchCurrentLocation();
  }
});
</script>
{% endblock %}
