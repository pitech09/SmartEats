{% extends "adminlayout.html" %}
{% block title %}Update Store Location{% endblock %}

{% block content %}
<div class="container my-5">
  <h2 class="text-center mb-4">Update Store Location</h2>

  <form method="POST" action="{{ url_for('store.update_store_location') }}">
    {{ form.hidden_tag() }}

    <div class="mb-3">
      {{ form.latitude.label }}
      {{ form.latitude(class='form-control', id='latitude') }}
    </div>

    <div class="mb-3">
      {{ form.longitude.label }}
      {{ form.longitude(class='form-control', id='longitude') }}
    </div>

    <div class="mb-3">
      <button type="button" class="btn btn-primary" id="use-location">
        Use My Current Location
      </button>
    </div>

    <div id="map" style="height: 500px; border:1px solid #ccc; border-radius:8px;"></div>

    <button type="submit" class="btn btn-success mt-3">Save Location</button>
  </form>
</div>

<!-- Local Leaflet files to avoid CSP issues -->
<link rel="stylesheet" href="{{ url_for('static', filename='lib/leaflet.css') }}">
<script src="{{ url_for('static', filename='lib/leaflet.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const latInput = document.getElementById('latitude');
  const lngInput = document.getElementById('longitude');
  const useBtn = document.getElementById('use-location');

  // Default map center (if no coordinates)
  let defaultLat = latInput.value ? parseFloat(latInput.value) : -28.895383;
  let defaultLng = lngInput.value ? parseFloat(lngInput.value) : 27.907324;
  let zoomLevel = latInput.value && lngInput.value ? 16 : 5;

  // Initialize map
  const map = L.map('map').setView([defaultLat, defaultLng], zoomLevel);

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Add marker
  let marker = L.marker([defaultLat, defaultLng], {draggable:true}).addTo(map);

  marker.on('dragend', function(e){
    const pos = e.target.getLatLng();
    latInput.value = pos.lat.toFixed(6);
    lngInput.value = pos.lng.toFixed(6);
  });

  // Autofill inputs if coordinates exist
  latInput.value = defaultLat.toFixed(6);
  lngInput.value = defaultLng.toFixed(6);

  // Use browser geolocation
  useBtn.addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser.');
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const {latitude, longitude} = position.coords;
        latInput.value = latitude.toFixed(6);
        lngInput.value = longitude.toFixed(6);
        marker.setLatLng([latitude, longitude]);
        map.setView([latitude, longitude], 16);
      },
      (error) => {
        alert('Unable to retrieve your location: ' + error.message);
      },
      {enableHighAccuracy:true}
    );
  });

  console.log('Map initialized at:', defaultLat, defaultLng);
});
</script>
{% endblock %}
